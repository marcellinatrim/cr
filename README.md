# Pavuk Crawler

Этот репозиторий содержит рефакторинг краулера `pavuk5_refactored.go`. Скрипт можно собрать и запустить без внешних Go-зависимостей.

## Требования

- Go 1.24+
- Доступ на запись к каталогам, указанным в конфиге (`./data/queue`, `./data/checkpoint`, `./data/output` по умолчанию).

## Сборка

По умолчанию команда `go` может попытаться загрузить недостающий toolchain (Go 1.25). Чтобы избежать сетевых запросов в изолированной среде, воспользуйтесь локальным toolchain:

```bash
export GOTOOLCHAIN=local
```

После этого выполните сборку:

```bash
go build ./...
```

При успешной сборке бинарник `pavuk` появится в корне репозитория.

## Запуск

1. Подготовьте файл со списком доменов (при первом запуске скрипт создаст
   плейсхолдер автоматически, если файл не найден):

   ```bash
   cat <<'EOF' > domains.txt
   example.com
   another-domain.org
   EOF
   ```

   > На Windows путь вида `/tmp/domains.txt` будет автоматически преобразован в
   > `.\tmp\domains.txt`. Если файла нет, краулер создаст плейсхолдер с
   > комментариями и примером домена.

2. Запустите краулер прямо из исходников. Минимальная команда для старта:

   ```bash
   go run pavuk5_refactored.go -domains ./domains.txt
   ```

   При необходимости укажите каталоги для очереди, чекпоинтов и результатов:

   ```bash
   go run pavuk5_refactored.go -domains ./domains.txt -queue ./data/queue -checkpoint ./data/checkpoint -output ./data/output
   ```

   Дополнительные флаги:

   - `-rate-limit` / `-rate-limit-rps` — включение и настройка пер-доменного лимитера запросов.
   - `-respect-robots` — строгая проверка правил `robots.txt` вместо режима логирования по умолчанию.
   - `-stats-interval` — период записи агрегированной статистики в `global_stats.json`.

3. Для просмотра доступных параметров выполните:

   ```bash
   go run pavuk5_refactored.go --help
   ```

Каталоги, указанные во флагах, будут созданы автоматически, если не существуют.

## Выходные данные

- `data/output/findings.jsonl` — результаты в формате JSONL.
- `data/output/tier{1-4}.txt` — списки URL по Tier.
- `data/output/global_stats.json` — агрегированная статистика по прогрессу и ошибкам.
- `data/queue/` и `data/checkpoint/` — рабочие директории очереди и снимков состояния.

## Отладка и диагностика

- Логи по умолчанию выводятся в текстовом формате. Изменить формат можно флагом `--log-json`.
- Для корректного завершения предусмотрена обработка `SIGINT`/`SIGTERM`: при нажатии `Ctrl+C` краулер вызовет `Shutdown()` и запишет финальные снапшоты.
- В случае проблем с кодировкой HTML тело ответа конвертируется в UTF-8 для распространённых однобайтовых кодировок (`latin1`, `windows-1251/1252`, `koi8-r`).

## Быстрый старт

```bash
export GOTOOLCHAIN=local
mkdir -p data/queue data/checkpoint data/output
go run ./pavuk5_refactored.go --help
```

Эти команды позволят убедиться, что скрипт запускается и выводит справку без необходимости загружать внешние пакеты.
